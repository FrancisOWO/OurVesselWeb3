{% extends "dash.html" %}

{% block dash_app %}

<style type="text/css">
	.holiday {
		color: red!important;
	}
	#allmap {width: 100%;height: 100%;overflow: hidden;margin:0;font-family:"微软雅黑";}
</style>

<!--日历css-->
<link rel="stylesheet" href="{{ url_for('static',filename='css/bootstrap-datepicker.min.css') }}">
<!--日历插件js-->
<script src="{{ url_for('static',filename='js/bootstrap-datepicker.min.js') }}"></script>
<script src="{{ url_for('static',filename='js/bootstrap-datepicker.zh-CN.min.js') }}"></script>


<script type="text/javascript" src="//api.map.baidu.com/api?type=webgl&v=1.0&ak={{ak}}"></script>
<script type="text/javascript" src="{{url_for('static',filename='js/bmap.js')}}"></script>

<!-- <main class="dash-content">
	<div class="container-fluid"> -->
		<div id="allmap"></div>
		<div class="row" style="z-index: 99;">
	        <div id="cardPort" style="position:fixed; top:100px; left:250px; width:500px; display:none;">
	            <div class="card easion-card">
	                <div class="card-header bg-primary text-white">
	                    <div class="easion-card-icon">
	                        <i class="fas fa-parking"></i>
	                    </div>
	                    <div class="easion-card-title">
	                    	<span id="portName"> 港口 - Port </span>
	                    	<br>
	                    	<span id="ctryName" style="font-size: small;"> 国家 - Country </span>
	                    </div>
	                    <div class="easion-card-menu">
                            <div class="dropdown show">
                                <a class="easion-card-menu-link" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"> 
                                </a>
                                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuLink">
                                    <a class="dropdown-item" id="tabCalendar">港口日历</a>
                                    <a class="dropdown-item" id="tabForecast">港口天气</a>
                                </div>
                            </div>
                        </div>
	                    <div id="closePort" role="button" style="margin-left: 30px;"> &times; </div>
	                </div>
	                <div class="card-body ">
	                	<h5 id="tabPort" style="margin-bottom: 15px;"> 港口信息 </h5>
	                	<table id="tblPort">
	                		<thead>
		                		<tr>
		                			<th scope="col" style="width: 80px;"></th>
		                			<th scope="col"></th>
		                		</tr>
	                		</thead>
	                		<tbody>
		                		<tr>
		                			<th scope="row">中文名称</th>
		                			<td id="nameCn">测试</td>
		                		</tr>
		                		<tr>
		                			<th scope="row">英文名称</th>
		                			<td id="nameEn">CE SHI</td>
		                		</tr>
		                		<tr style="display: none;">
		                			<th scope="row">国家代码</th>
		                			<td id="ctryCode">CN</td>
		                		</tr>
		                		<tr>
		                			<th scope="row">港口代码</th>
		                			<td id="portCode">TEST</td>
		                		</tr>
		                		<tr>
		                			<th scope="row">港口坐标</th>
		                			<td id="portCoords">0 N, 0 E</td>
		                		</tr>
	                		</tbody>
	                	</table>
	                </div>
	            </div>
	        </div>
	        <div id="cardCalendar" style="position:fixed; top:350px; left:250px; display:none;">
		        <div class="card easion-card">
	                <div class="card-header bg-success text-white">
	                    <div class="easion-card-icon">
	                        <i class="fas fa-calendar-alt"></i>
	                    </div>
	                    <div class="easion-card-title"> 港口日历 </div>
	                    <div class="easion-card-menu" id="closeCalendar" role="button"> &times; </div>
	                </div>
	                <div class="card-body">
	                	<div id="calendar" class="bench-calendar">
							<!-- 这里是日历 -->
						</div>
	                </div>
	            </div>
	       	</div>
	       	<div id="cardDate" style="position:fixed; top:420px; left:730px; min-width: 400px; display:none;">
		        <div class="card easion-card">
	                <div class="card-header">
	                    <div class="easion-card-icon">
	                        <i class="far fa-sticky-note"></i>
	                    </div>
	                    <div class="easion-card-title"> 日期详情 </div>
	                    <div class="easion-card-menu" id="closeDate" role="button"> &times; </div>
	                </div>
	                <div class="card-body">
	                	<p id="activeDate"> 2022年12月5日 </p>
	                	<div id="holidays">
							<p>无假期信息</p>
						</div>
	                </div>
	            </div>
	       	</div>
	        <div id="cardForecast" style="position:fixed; top:180px; left:480px; display:none;">
		        <div class="card easion-card">
	                <div class="card-header bg-info text-white">
	                    <div class="easion-card-icon">
	                        <i class="fas fa-cloud-sun"></i>
	                    </div>
	                    <div class="easion-card-title"> 港口天气 </div>
	                    <div class="easion-card-menu" id="closeForecast" role="button"> &times; </div>
	                </div>
	                <div class="card-body" style="width:950px; margin-left:20px">
	                	<div style="display:inline-block; text-align:center; float:left; margin-top:20px">
							<h3 id="wPortName" style="margin-top:10px">港口名</h3>
							<img id="iconData" style="height:120px;"/>
							<div id="description" style="height:35px; font-size:large;">天气描述</div>
							<div id="temperature" style="height:35px; font-size:large;">温度</div>
							<table style="font-size:medium; margin-top:20px">
								<thead>
									<tr>
										<td style="width:100px"></td>
										<td></td>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td>体感温度</td>
										<td id="feelLike">None</td>
									</tr>
									<tr>
										<td>风速</td>
										<td id="windSpeed">None</td>
									</tr>
									<tr>
										<td>风向</td>
										<td id="windDeg">None</td>
									</tr>
									<tr>
										<td>湿度</td>
										<td id="humidity">None</td>
									</tr>
									<tr>
										<td>气压</td>
										<td id="pressure">None</td>
									</tr>											
								</tbody>
							</table>
						</div>
						<div style="display: inline-block; float:right; margin-top:20px">
							<div id="forecastDetail" style="font-size: small; margin-left: 50px;">
							</div>
							<div class="card-body easion-card-body-chart" style="width:600px; margin-top:30px;">
	                            <canvas id="easionChartjsLine"></canvas>
	                        </div>
                        </div>
	                </div>
	            </div>
	       	</div>
		</div>
<!-- 	</div>
</main> -->

<script type="text/javascript">
	$(document).ready(function () {
		// 百度地图
		let map = new BMapGL.Map("allmap");	// 创建Map实例
		showBMap(map);

		// 搜索港口
		function searchPort() {
			let content = document.getElementById("txtSearch").value;
			if(content.length < 1)
				return;
			
			let url_get_port_info = "{{ url_for('map.get_port_info' )}}";
			//alert(content+" "+url_get_port_info);
			
			$.ajax({
				type: "GET",
				url: url_get_port_info,
				data: {
					"port": content,
					"last_code": $("#portCode").text()
				},
				success: function(data){
					// 查询失败
					if(data.status == false){
						let msg = "未搜索到港口【" + content + "】相关信息";
						alert(msg);
						return;
					}

					// 和上次查询一样，无需重复设置
					if(data.status == "same"){
						$("#cardPort").show();
						return;
					}

					let portName = data.nameCn + " - " + data.nameEn;
					$("#portName").text(portName);

					let ctryName = data.ctryNameCn + " - " + data.ctryNameEn;
					$("#ctryName").text(ctryName);
					$("#ctryCode").text(data.ctryCode);

					$("#nameCn").text(data.nameCn);
					$("#nameEn").text(data.nameEn);
					$("#portCode").text(data.portCode);

					let coords = data.latStr + " N, " + data.lonStr + " E";
					$("#portCoords").text(coords);

					$("#cardPort").show();

					// 地图标记
					mapCenterAndZoom(map, data.lon, data.lat, 11)
					markCurrentPoint(map, data.lon, data.lat, data.nameCn);
					//map.centerAndZoom(new BMapGL.Point(106, 34), 8);
				},
				error: function(){
					alert("ERROR: searchPort");
				}
			});
		}

		$("#closePort").on("click", function(){
			$("#cardPort").hide();
		});

		$("#closeCalendar").on("click", function(){
			$("#cardCalendar").hide();
		});

		$("#closeDate").on("click", function(){
			$("#cardDate").hide();
		});

		$("#closeForecast").on("click", function(){
			$("#cardForecast").hide();
		});

		// TODO: 搜索框内容变化，智能提示
		$("#txtSearch").on("input propertychange", function(){
			let content = document.getElementById("txtSearch").value;
			// if(content.length > 0)
			// 	$("#listSearch").show();
			// else
			// 	$("#listSearch").hide();

			// port_list = document.getElementById("listSearch");
			// let opts = "";
			// for (var i = 0; i < port_list.options.length; i++) {
			//   opts = opts + port_list.options[i].value + "\n";
			//  }
			// alert(opts);
		});

		// 回车搜索
		$("#txtSearch").keypress(function(e){
			let ev = e || event;
			if(ev.keyCode == 13){
				searchPort();
			}
		});

		// 点击搜索
		$("#btnSearch").click(function() {
			searchPort();
		});


		function resizeCalendar() {
			$(".datepicker").css({"width":"440px"});
			// 日期选择表
			$(".datepicker-days thead tr").each(function (idx, elem){
				if(idx == 0)	//标题高度不变
					return;
				$(this).css({"height":"50px"});
			});
			// 月份选择表
			$(".datepicker-months thead tr").each(function (idx, elem){
				if(idx == 0)	//标题高度不变
					return;
				$(this).css({"height":"50px"});
			});
			$(".datepicker-years thead tr").each(function (idx, elem){
				if(idx == 0)	//标题高度不变
					return;
				$(this).css({"height":"50px"});
			});
			$(".datepicker-decades thead tr").each(function (idx, elem){
				if(idx == 0)	//标题高度不变
					return;
				$(this).css({"height":"50px"});
			});
			$(".datepicker-centuries thead tr").each(function (idx, elem){
				if(idx == 0)	//标题高度不变
					return;
				$(this).css({"height":"50px"});
			});
			$(".table-condensed tbody tr").each(function (idx, elem){
				$(this).css({"height":"50px"});
			});
			$(".dow").each(function (idx, elem) {
				$(this).css({"width":"60px"});
			});
		};

		function changeSwitchBody(size) {
			setTimeout(function (size) {;
				$(".datepicker").css({"width":"200px"});
			},0);
		};

		function markHolidays() {
			let url_get_holidays = "{{ url_for('map.get_holidays') }}"
			// alert(url_get_holidays);

			$.ajax({
				type: "GET",
				url: url_get_holidays,
				data: {
					"ctryCode": $("#ctryCode").text(),
					"year": $(".year.focused").text(),
					"month": $(".month.focused").text().slice(0,-1), //xx月 => xx
				},
				success: function(data){
					// if(data == null)
					// 	return;

					//alert("len: " + data.length)
					let note_style = "style='font-size:x-small;'";
					// 查询成功
					$(".old.day").each(function (idx, elem) {
						let txt = $(this).text();
						let note = "&nbsp;";
						$(this).html(txt + "<br><div " + note_style + ">" + note + "</div>");
					});
					$(".day").not(".old").not(".new").each(function (idx, elem) {
						// 添加样式
						let txt = $(this).text();
						let note = "&nbsp;";
						let holidays_html = "<p>无假期信息</p>";
						for(let i=0; i < data.length; i++){
							if(1+idx == data[i]["dateDay"]){
								$(this).addClass("holiday");
								note = "节假日";
								let holidays = data[i]["holidays"];
								holidays_html = "<p>假期信息:</p>"
								for(let k=0; k < holidays.length; k++){
									holidays_html = holidays_html + "<p>"
										+ (k+1) + ".&nbsp;" + holidays[k]["holidayNameEn"] 
										+ "&nbsp;【" + holidays[k]["holidayType"]  + "】"
										+ "</p>";
								}
								break;
							}
						}
						$(this).html(txt + "<br><div " + note_style + ">" + note + "</div>");
						$(this).click(function(){
							setTimeout(function () {
								changeCalendarBody();
								// 日期
								let activeDate = $(".year.focused").text() + "年"
									+ $(".month.focused").text()
									+ $(".active.day").text() + "日";
								$("#activeDate").text(activeDate);
								$("#holidays").html(holidays_html);
								$("#cardDate").show();
							},0);
						});
					});
					$(".new.day").each(function (idx, elem) {
						let txt = $(this).text();
						let note = "&nbsp;";
						$(this).html(txt + "<br><div " + note_style + ">" + note + "</div>");
					});
				},
				error: function(){
					alert("ERROR: markHolidays");
				}
			});
		}

		function changeCalendarBody() {
			setTimeout(function () {
				$(".datepicker").css({"width":"440px"});
				// $(".day").each(function (idx, elem) {
				// 	let txt = $(this).text();
				// 	$(this).html(txt+"<br>");
				// });
				markHolidays();
			},0);
		};

		// 日历
		$("#calendar").datepicker({
			language: "zh-CN",
			autoclose: true,
			todayHighlight: true
		});

		resizeCalendar();
		changeCalendarBody();

		// 填充天气预报面板
		function fillForecast() {
			let url_get_forecast =  "{{ url_for('map.get_forecast') }}";
			let portCode = $("#portCode").text(); //"CNYSN";
			$.ajax({
				type: "GET",
				url: url_get_forecast,
				data: {
					"portCode": portCode
				},
				success: function(data){

					// 今日天气
					let today = data.current;

					// <div id="wPortName">港口名</div>
					// <div id="description">天气描述</div>
					// <img id="iconData" width="100px">
					// <div id="temperature">温度</div>
					// <div id="windSpeed">风速</div>
					// <div id="windDeg">风向</div>
					// <div id="feelLike">体感温度</div>
					$("#wPortName").text($("#nameCn").text());
					$("#description").text(today.description);
					$("#iconData").attr("src", today.iconData);
					$("#temperature").text(today.temp + " ℃");

					let windSpeed = today.windSpeed + " m/s (" + today.windSpeedLevel + "级)";
					let windDeg = today.windDeg + "° (" + today.windDegCn + ")";
					$("#windSpeed").text(windSpeed);
					$("#windDeg").text(today.description);
					$("#feelLike").text(today.feelLike + " ℃");
					$("#humidity").text(today.humidity + " %");
					$("#pressure").text(today.pressure + " hPa");

					// 天气预报
					let fdetail = data.forecastDetail;

					let dayWeekDescCn = fdetail.dayWeekDescCn;
					dayWeekDescCn[0] = "今天";

					let tempMax = fdetail.tempMax;
					let tempMin = fdetail.tempMin;

					// 显示下面一周的天气 【星期，图标，天气】
					let fcontent = "";
					for(let i = 0; i < fdetail.description.length; i++){
						fcontent = fcontent
							+ '<div style="text-align:center; display:inline-block; width:65px;">'
								+ '<div>' + fdetail.dayWeekDescCn[i] + '</div>'		// 星期几
								+ '<img height="55px" src="' + fdetail.iconData[i] + '"</div>'	// 天气图标
								+ '<div>' + fdetail.description[i] + '</div>'		// 天气描述
							+ '</div>';
					}
					$("#forecastDetail").html(fcontent);

					// 画气温折线图
                    var ctx = document.getElementById("easionChartjsLine").getContext('2d');
                    var myChart = new Chart(ctx, {
                        type: 'line',
                        data: {
			                labels: dayWeekDescCn, // ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
			                datasets: [
			                {
			                    label: '最高气温',
			                    data: tempMax, // [4, 12, 11, 2, 14],
			                    backgroundColor: window.chartColors.danger,
			                    borderColor: window.chartColors.danger,
			                    fill: false,
			                    lineTension: 0
			                },
			                {
			                    label: '最低气温',
			                    data: tempMin, // [12, 19, 3, 5, 2],
			                    backgroundColor: window.chartColors.primary,
			                    borderColor: window.chartColors.primary,
			                    fill: false,
			                    lineTension: 0
			                }]
                        },
			            options: {
			                legend: {
			                    display: true
			                },
						    scales: {
						        xAxes: [{
						            gridLines: {
						                display: false
						            }
						        }],
						        yAxes: [{
						        	display: false
						        }]
						    },
			                // 默认显示数据值
			                animation: {
				                onComplete: function() {
				                	let chartInst = this.chart;
				                	let ctx = chartInst.ctx;
									ctx.font = Chart.helpers.fontString(Chart.defaults.global.defaultFontSize, Chart.defaults.global.defaultFontStyle, Chart.defaults.global.defaultFontFamily);
			                        ctx.textAlign = 'center';
			                        ctx.textBaseline = 'bottom';

				                	this.data.datasets.forEach(function(dataset, i){
				                		if(i == 0)
				                			ctx.fillStyle = window.chartColors.danger;
				                		else
				                			ctx.fillStyle = window.chartColors.primary;

				                		let meta = chartInst.controller.getDatasetMeta(i);
				                		meta.data.forEach(function(bar, index){
				                			let data = dataset.data[index] + "℃";
				                			ctx.fillText(data, bar._model.x, bar._model.y-5);
				                		});
				                	});
				                }
				            }
			            }
                    });
				},
				error: function(){
					alert("ERROR: fillForecast");
				}
			});
	    }

		$(".datepicker-days .prev").on("click", function() {
			changeCalendarBody();
		});
		$(".datepicker-days .next").on("click", function() {
			changeCalendarBody();
		});
		$(".datepicker-switch").on("click", function() {
			changeSwitchBody();
		});
		// 切回日历，调整页面大小
		$(".datepicker-months tbody").on("click", function() {
			changeCalendarBody();
		});

		$("#tabForecast").on("click", function() {
	    	fillForecast();
			$("#cardForecast").show();
		});
		$("#tabCalendar").on("click", function() {
			$("#cardCalendar").show();
		});


		// 悬浮窗
		hoverElementByID("cardPort");
		hoverElementByID("cardCalendar");
		hoverElementByID("cardForecast");
		hoverElementByID("cardDate");

	});
</script>

{% endblock dash_app %}
